# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19e8BHXBQCD1pU4Me4wGJRiJFHlrGL5vW
"""

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# import streamlit as st
# from geopy.distance import geodesic
# import datetime
# import urllib.parse
# import smtplib
# from email.mime.text import MIMEText
# 
# st.title("ðŸš‘ Smart Patient Visit Optimizer")
# 
# # Doctor start location
# st.header("Doctor Start Location")
# start_lat = st.number_input("Start Latitude", value=9.9200)
# start_lon = st.number_input("Start Longitude", value=78.1200)
# 
# # Add patients
# st.header("Add Patients")
# 
# num_patients = st.number_input("Number of Patients", min_value=1, step=1)
# 
# patients = []
# 
# for i in range(int(num_patients)):
#     st.subheader(f"Patient {i+1}")
#     name = st.text_input(f"Name {i}", key=f"name{i}")
#     lat = st.number_input(f"Latitude {i}", key=f"lat{i}")
#     lon = st.number_input(f"Longitude {i}", key=f"lon{i}")
#     available_from = st.number_input(f"Available From (24h)", key=f"from{i}")
#     available_to = st.number_input(f"Available To (24h)", key=f"to{i}")
# 
#     patients.append({
#         "name": name,
#         "lat": lat,
#         "lon": lon,
#         "from": available_from,
#         "to": available_to
#     })
# 
# if st.button("Generate Optimized Schedule"):
# 
#     start = (start_lat, start_lon)
#     current_time = 9
#     speed = 35
# 
#     hour = datetime.datetime.now().hour
#     if 8 <= hour <= 10 or 17 <= hour <= 19:
#         traffic_multiplier = 1.3
#     else:
#         traffic_multiplier = 1.0
# 
#     # Sort nearest first
#     patients.sort(key=lambda c: geodesic(start, (c["lat"], c["lon"]))).km)
# 
#     schedule = []
# 
#     for p in patients:
#         distance_km = geodesic(start, (p["lat"], p["lon"]))).km
#         travel_minutes = (distance_km / speed) * 60 * traffic_multiplier
#         arrival_time = current_time + travel_minutes / 60
# 
#         if arrival_time < p["from"]:
#             arrival_time = p["from"]
# 
#         if arrival_time <= p["to"]:
#             schedule.append((p["name"], round(arrival_time,2)))
#             current_time = arrival_time + 1
#             start = (p["lat"], p["lon"])
# 
#     message = "Optimized Visit Plan:\n\n"
#     for s in schedule:
#         message += f"{s[0]} at {s[1]} hrs\n"
# 
#     st.success("Schedule Generated!")
#     st.text(message)
# 
#     # WhatsApp Link
#     doctor_phone = st.text_input("Doctor WhatsApp Number (with country code)")
#     if doctor_phone:
#         encoded_message = urllib.parse.quote(message)
#         whatsapp_link = f"https://wa.me/{doctor_phone}?text={encoded_message}"
#         st.markdown(f"[ðŸ“² Send via WhatsApp]({whatsapp_link})")
# 
#     # Email Option
#     st.header("Send Email")
#     sender = st.text_input("Your Gmail")
#     password = st.text_input("App Password", type="password")
#     receiver = st.text_input("Doctor Email")
# 
#     if st.button("Send Email"):
#         msg = MIMEText(message)
#         msg["Subject"] = "Optimized Patient Visit Schedule"
#         msg["From"] = sender
#         msg["To"] = receiver
# 
#         server = smtplib.SMTP("smtp.gmail.com", 587)
#         server.starttls()
#         server.login(sender, password)
#         server.sendmail(sender, receiver, msg.as_string())
#         server.quit()
# 
#         st.success("Email Sent Successfully!")

import streamlit as st
from geopy.distance import geodesic
import datetime
import urllib.parse
import smtplib
from email.mime.text import MIMEText

st.title("ðŸš‘ Smart Patient Visit Optimizer")

# Doctor start location
st.header("Doctor Start Location")
start_lat = st.number_input("Start Latitude", value=9.9200)
start_lon = st.number_input("Start Longitude", value=78.1200)

# Add patients
st.header("Add Patients")

num_patients = st.number_input("Number of Patients", min_value=1, step=1)

patients = []

for i in range(int(num_patients)):
    st.subheader(f"Patient {i+1}")
    name = st.text_input(f"Name {i}", key=f"name{i}")
    lat = st.number_input(f"Latitude {i}", key=f"lat{i}")
    lon = st.number_input(f"Longitude {i}", key=f"lon{i}")
    available_from = st.number_input(f"Available From (24h)", key=f"from{i}")
    available_to = st.number_input(f"Available To (24h)", key=f"to{i}")

    patients.append({
        "name": name,
        "lat": lat,
        "lon": lon,
        "from": available_from,
        "to": available_to
    })

if st.button("Generate Optimized Schedule"):

    start = (start_lat, start_lon)
    current_time = 9
    speed = 35

    hour = datetime.datetime.now().hour
    if 8 <= hour <= 10 or 17 <= hour <= 19:
        traffic_multiplier = 1.3
    else:
        traffic_multiplier = 1.0

    # Sort nearest first
    patients.sort(key=lambda c: geodesic(start, (c["lat"], c["lon"])).km)

    schedule = []

    for p in patients:
        distance_km = geodesic(start, (p["lat"], p["lon"])).km
        travel_minutes = (distance_km / speed) * 60 * traffic_multiplier
        arrival_time = current_time + travel_minutes / 60

        if arrival_time < p["from"]:
            arrival_time = p["from"]

        if arrival_time <= p["to"]:
            schedule.append((p["name"], round(arrival_time,2)))
            current_time = arrival_time + 1
            start = (p["lat"], p["lon"])

    message = "Optimized Visit Plan:\n\n"
    for s in schedule:
        message += f"{s[0]} at {s[1]} hrs\n"

    st.success("Schedule Generated!")
    st.text(message)

    # WhatsApp Link
    doctor_phone = st.text_input("Doctor WhatsApp Number (with country code)")
    if doctor_phone:
        encoded_message = urllib.parse.quote(message)
        whatsapp_link = f"https://wa.me/{doctor_phone}?text={encoded_message}"
        st.markdown(f"[ðŸ“² Send via WhatsApp]({whatsapp_link})")

    # Email Option
    st.header("Send Email")
    sender = st.text_input("Your Gmail")
    password = st.text_input("App Password", type="password")
    receiver = st.text_input("Doctor Email")

    if st.button("Send Email"):
        msg = MIMEText(message)
        msg["Subject"] = "Optimized Patient Visit Schedule"
        msg["From"] = sender
        msg["To"] = receiver

        server = smtplib.SMTP("smtp.gmail.com", 587)
        server.starttls()
        server.login(sender, password)
        server.sendmail(sender, receiver, msg.as_string())
        server.quit()

        st.success("Email Sent Successfully!")